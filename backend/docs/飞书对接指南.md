# 飞书云文档对接指南

## 📋 准备工作

### 第一步：创建飞书应用

1. 访问 [飞书开放平台](https://open.feishu.cn/)
2. 点击「创建企业自建应用」
3. 填写应用信息：
   - 应用名称：OutBook 数据同步
   - 应用描述：OutBook 项目管理系统数据同步服务
4. 创建成功后，获取：
   - **App ID**（应用凭证）
   - **App Secret**（应用凭证）

### 第二步：申请权限

在应用管理页面，点击「权限管理」，申请以下权限：

#### 如果使用多维表格（推荐）：
- ✅ `bitable:app` - 获取多维表格信息
- ✅ `bitable:app:readonly` - 查看多维表格（只读）
- ✅ `bitable:app:readwrite` - 编辑多维表格（如果需要写入）

#### 如果使用电子表格：
- ✅ `sheets:spreadsheet` - 查看和编辑电子表格
- ✅ `sheets:spreadsheet:readonly` - 查看电子表格（只读）

#### 如果使用云文档：
- ✅ `docx:document` - 查看和编辑云文档
- ✅ `docx:document:readonly` - 查看云文档（只读）

### 第三步：获取文档信息

#### 方式 1：多维表格（Bitable）

1. 打开你的飞书多维表格
2. 查看浏览器地址栏，URL 格式如下：
   ```
   https://xxx.feishu.cn/base/{app_token}?table={table_id}&view={view_id}
   ```
3. 提取信息：
   - `app_token`: 多维表格的唯一标识
   - `table_id`: 数据表的唯一标识

**示例：**
```
URL: https://example.feishu.cn/base/bascnABC123xyz?table=tblXYZ789abc&view=vewDEF456
提取：
  app_token = bascnABC123xyz
  table_id = tblXYZ789abc
```

#### 方式 2：电子表格（Spreadsheet）

1. 打开你的飞书电子表格
2. 查看浏览器地址栏，URL 格式如下：
   ```
   https://xxx.feishu.cn/sheets/{spreadsheet_token}
   ```
3. 提取 `spreadsheet_token`

#### 方式 3：云文档（Doc）

1. 打开你的飞书云文档
2. 查看浏览器地址栏，URL 格式如下：
   ```
   https://xxx.feishu.cn/docx/{document_id}
   ```
3. 提取 `document_id`

---

## 🔧 配置后端服务

### 1. 编辑 `.env` 文件

```bash
cd backend
nano .env  # 或使用其他编辑器
```

### 2. 填入飞书配置

```env
# 飞书应用配置
FEISHU_APP_ID=cli_xxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxx

# 如果使用多维表格
FEISHU_PROJECT_APP_TOKEN=bascnABC123xyz
FEISHU_PROJECT_TABLE_ID=tblXYZ789abc

FEISHU_BUG_APP_TOKEN=bascnDEF456uvw
FEISHU_BUG_TABLE_ID=tblUVW123def

# ... 其他表格配置
```

---

## 📊 推荐的飞书多维表格结构

### 表 1：项目表（Projects）

| 字段名 | 字段类型 | 说明 | 示例 |
|--------|----------|------|------|
| 项目名称 | 文本 | 项目名称 | 清华大学智慧校园系统 |
| 学校名称 | 文本 | 客户学校 | 清华大学 |
| 合同金额 | 数字 | 合同金额（元） | 1200000 |
| 实际成本 | 数字 | 实际成本（元） | 720000 |
| 利润 | 公式 | 合同金额 - 实际成本 | 480000 |
| 利润率 | 公式 | (利润 / 合同金额) * 100 | 40 |
| 状态 | 单选 | 进行中/已完成/规划中 | 进行中 |
| 开始日期 | 日期 | 项目开始日期 | 2024-01-15 |
| 结束日期 | 日期 | 项目结束日期 | 2024-06-30 |
| 项目经理 | 人员 | 项目负责人 | @张三 |
| 团队成员 | 人员(多选) | 团队成员列表 | @张三 @李四 |
| 项目描述 | 文本 | 项目简介 | 为清华大学打造... |
| 进度 | 数字 | 完成进度(%) | 65 |

### 表 2：Bug 表（Bugs）

| 字段名 | 字段类型 | 说明 | 示例 |
|--------|----------|------|------|
| 所属项目 | 关联 | 关联项目表 | 清华大学智慧校园系统 |
| Bug标题 | 文本 | Bug 简述 | 登录页面样式错乱 |
| Bug描述 | 文本 | 详细描述 | 在移动端登录页面... |
| 严重程度 | 单选 | 高/中/低 | 中 |
| 状态 | 单选 | 待处理/处理中/已解决 | 已解决 |
| 负责人 | 人员 | 处理人员 | @李四 |
| 报告人 | 人员 | 报告人员 | @张三 |
| 创建时间 | 日期 | 创建时间 | 2024-05-10 10:30 |
| 解决时间 | 日期 | 解决时间 | 2024-05-11 15:20 |

### 表 3：工单表（Tickets）

| 字段名 | 字段类型 | 说明 | 示例 |
|--------|----------|------|------|
| 所属项目 | 关联 | 关联项目表 | 清华大学智慧校园系统 |
| 工单标题 | 文本 | 工单简述 | 数据库性能优化 |
| 工单类型 | 单选 | 维护/修复/新功能 | 维护 |
| 状态 | 单选 | 待处理/处理中/已完成 | 已完成 |
| 优先级 | 单选 | 高/中/低 | 高 |
| 负责人 | 人员 | 处理人员 | @张三 |
| 创建时间 | 日期 | 创建时间 | 2024-06-01 09:00 |
| 完成时间 | 日期 | 完成时间 | 2024-06-05 17:00 |

### 表 4：成员表（Members）

| 字段名 | 字段类型 | 说明 | 示例 |
|--------|----------|------|------|
| 姓名 | 文本 | 成员姓名 | 张三 |
| 职位 | 文本 | 职位 | 高级工程师 |
| 所属项目 | 多选 | 参与的项目 | 项目A, 项目B |
| 工作天数 | 数字 | 累计工作天数 | 120 |
| Bug数量 | 数字 | 负责的Bug数 | 15 |
| 效率分数 | 数字 | 工作效率评分 | 85 |

### 表 5：知识库表（Knowledge）

| 字段名 | 字段类型 | 说明 | 示例 |
|--------|----------|------|------|
| 文档标题 | 文本 | 文档名称 | 需求文档 |
| 文档类型 | 单选 | 需求/设计/API/手册 | 需求 |
| 所属项目 | 关联 | 关联项目表 | 清华大学智慧校园系统 |
| 状态 | 单选 | 草稿/已发布 | 已发布 |
| 作者 | 人员 | 文档作者 | @张三 |
| 文档链接 | URL | 飞书文档链接 | https://... |
| 创建时间 | 日期 | 创建时间 | 2024-01-10 |
| 更新时间 | 日期 | 最后更新时间 | 2024-01-15 |

---

## 🧪 测试连接

### 1. 启动后端服务

```bash
cd backend
npm run dev
```

### 2. 测试健康检查

```bash
curl http://localhost:3000/health
```

应该返回：
```json
{
  "status": "ok",
  "timestamp": "2024-11-04T..."
}
```

### 3. 测试飞书连接

```bash
curl http://localhost:3000/api/projects
```

如果配置正确，应该返回项目列表数据。

---

## ❓ 常见问题

### Q1: 提示 "飞书 API 错误: 99991663"
**原因**: 应用没有权限访问该文档
**解决**: 
1. 在飞书文档中，点击右上角「分享」
2. 添加你的应用为协作者
3. 或者在开放平台中重新申请权限

### Q2: 提示 "app_token 或 table_id 无效"
**原因**: 文档 ID 提取错误
**解决**: 重新检查 URL，确保提取的 ID 正确

### Q3: 数据为空
**原因**: 表格中没有数据，或字段名不匹配
**解决**: 
1. 检查表格中是否有数据
2. 检查字段名是否与代码中的一致（区分大小写）

---

## 📞 需要帮助？

如果遇到问题，请提供：
1. 错误信息截图
2. `.env` 配置（隐藏敏感信息）
3. 飞书表格截图（隐藏敏感数据）

我会帮你解决！

